# .github/workflows/publish.yml
name: Build & Publish (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: '5 10 * * *'   # ~07:05 em São Paulo (UTC-3)
  push:
    branches:
      - main
    paths:
      - scripts/**
      - public/**
      - categoria/**
      - index.html
      - styles.css
      - package.json
      - package-lock.json
      - scripts/sources.js
      - .github/workflows/publish.yml

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: gh-pages
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci || npm i

      # Depuração do endpoint de tradução (não falha o job se der erro)
      - name: Debug LT endpoint (temporary)
        env:
          LT_ENDPOINT: ${{ secrets.LT_ENDPOINT }}
          LT_API_KEY: ${{ secrets.LT_API_KEY }}
        run: |
          echo "Testando LT_ENDPOINT: ${LT_ENDPOINT:-<vazio>}"
          if [ -n "$LT_ENDPOINT" ]; then
            echo "→ Fazendo POST de teste..."
            curl -s -X POST "$LT_ENDPOINT" \
              -H 'Content-Type: application/json' \
              -d "{\"q\":\"Hello world!\",\"source\":\"auto\",\"target\":\"pt\",\"api_key\":\"$LT_API_KEY\"}" \
              || true
            echo
          else
            echo "LT_ENDPOINT não definido (crie o Secret em Settings → Secrets and variables → Actions)."
          fi

      - name: Build (gera JSON, páginas internas, RSS e sitemap)
        env:
          LT_ENDPOINT: ${{ secrets.LT_ENDPOINT }}
          LT_API_KEY: ${{ secrets.LT_API_KEY }}
          TZ: America/Sao_Paulo
        run: |
          echo "LT_ENDPOINT está definido? $( [ -n "$LT_ENDPOINT" ] && echo sim || echo nao )"
          node -v
          npm run build

      - name: Post-build check (titles)
        run: |
          if [ -f public/data/news.json ]; then
            echo "Exibindo até 3 títulos:"
            if command -v jq >/dev/null 2>&1; then
              jq -r '.[0:3][] | "* \(.country): \(.title)"' public/data/news.json
            else
              head -c 1000 public/data/news.json
            fi
          else
            echo "public/data/news.json não encontrado."
          fi

      - name: Ensure .nojekyll
        run: |
          mkdir -p public
          touch public/.nojekyll

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "Publish: ${{ github.sha }}"
